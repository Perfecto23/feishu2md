name: Release on push to master (auto patch bump)

on:
  push:
    branches: [ master ]

permissions:
  contents: write

jobs:
  bump_tag:
    name: Compute next tag and push
    runs-on: ubuntu-latest
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Ensure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Compute next patch tag
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          latest_tag=$(git tag --list 'v[0-9]*.[0-9]*.[0-9]*' | sort -V | tail -n1 || true)
          if [[ -z "$latest_tag" ]]; then
            # Initial version if no tags exist
            new_tag="v0.1.0"
          else
            ver=${latest_tag#v}
            IFS='.' read -r major minor patch <<<"$ver"
            patch=$((patch+1))
            new_tag="v${major}.${minor}.${patch}"
          fi
          echo "latest_tag=$latest_tag" >> $GITHUB_OUTPUT
          echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
          echo "Next tag: $new_tag"

      - name: Create and push tag
        env:
          NEW_TAG: ${{ steps.bump.outputs.new_tag }}
        run: |
          set -euo pipefail
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"

  build_and_package:
    name: Build and package assets
    needs: bump_tag
    if: needs.bump_tag.outputs.new_tag != ''
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target: [ linux-amd64, linux-arm64, linux-386, linux-arm, darwin-arm64, darwin-amd64, windows-amd64, windows-386, windows-arm64 ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build and package (${{ matrix.target }})
        env:
          VERSION: ${{ needs.bump_tag.outputs.new_tag }}
        shell: bash
        run: |
          set -euo pipefail
          case "${{ matrix.target }}" in
            linux-amd64)   make package-linux-amd64    VERSION="$VERSION" ;;
            linux-arm64)   make package-linux-arm64    VERSION="$VERSION" ;;
            linux-386)     make package-linux-386      VERSION="$VERSION" ;;
            linux-arm)     make package-linux-arm      VERSION="$VERSION" ;;
            darwin-arm64)  make package-darwin-arm64   VERSION="$VERSION" ;;
            darwin-amd64)  make package-darwin-amd64   VERSION="$VERSION" ;;
            windows-amd64) make package-windows-amd64  VERSION="$VERSION" ;;
            windows-386)   make package-windows-386    VERSION="$VERSION" ;;
            windows-arm64) make package-windows-arm64  VERSION="$VERSION" ;;
          esac
          echo "Built artifacts:"
          ls -la bin || true

      - name: Upload artifacts (${{ matrix.target }})
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: |
            bin/*.tar.gz
            bin/*.zip
          if-no-files-found: error

  publish_release:
    name: Create GitHub Release and upload assets
    needs: [bump_tag, build_and_package]
    runs-on: ubuntu-latest
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          merge-multiple: true

      - name: List downloaded files
        run: |
          pwd
          ls -R

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.bump_tag.outputs.new_tag }}
          generate_release_notes: true
          files: |
            **/*.tar.gz
            **/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


